---
import Layout from '../../layouts/Layout.astro';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { ExternalLink, TrendingDown, Bell, Share2 } from 'lucide-react';
import type { DbServiceRpc, ProductDetails } from '@nerd-ofertas/types';
import PriceHistoryChart from '@/components/PriceHistoryChart';
import OfferList from '@/components/OfferList.astro';

export const prerender = false;

const { id } = Astro.params;
let product: ProductDetails | null = null;
let error = null;

try {
  const db = Astro.locals.runtime?.env?.DB_SERVICE;
  if (db && id) {
     product = await (db as unknown as DbServiceRpc).getProductDetails(id);
  }
} catch (e) {
  console.error("Failed to fetch product:", e);
  error = "Não foi possível carregar o produto.";
}

if (!product && !error) {
    return Astro.redirect('/404');
}

const formatPrice = (price: number) => {
    return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
    }).format(price / 100);
};

// Determine Main Offer (Lowest Price)
const mainOffer = product?.offers.reduce((prev, curr) => (prev.price < curr.price ? prev : curr), product?.offers[0]);

// Calculate discount for Main Offer
const mainDiscount = mainOffer && mainOffer.oldPrice && mainOffer.price < mainOffer.oldPrice
    ? Math.round(((mainOffer.oldPrice - mainOffer.price) / mainOffer.oldPrice) * 100)
    : 0;
---

<Layout title={product?.title || "Produto | Nerd Ofertas"}>
  <main class="min-h-screen bg-background pb-20">
    
    {/* Breadcrumb / Header Area could go here */}
    <div class="border-b border-border bg-card">
        <div class="container mx-auto px-4 py-4 flex items-center text-sm text-muted-foreground">
            <a href="/" class="hover:text-primary transition-colors">Home</a>
            <span class="mx-2">/</span>
            <a href="/search" class="hover:text-primary transition-colors">Produtos</a>
            <span class="mx-2">/</span>
            <span class="text-foreground font-medium truncate max-w-[200px]">{product?.title}</span>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
      {error ? (
          <div class="text-center py-20 bg-destructive/5 rounded-xl border border-destructive/20">
              <h1 class="text-2xl font-bold text-destructive mb-4">Erro ao carregar produto</h1>
              <p class="text-muted-foreground">{error}</p>
              <Button variant="outline" class="mt-6" asChild><a href="/">Voltar para Home</a></Button>
          </div>
      ) : (
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
              
              {/* Left Column: Image Gallery */}
              <div class="lg:col-span-5 space-y-6">
                  <div class="bg-white rounded-2xl border border-border p-8 flex items-center justify-center aspect-square relative overflow-hidden shadow-sm sticky top-24">
                       <img 
                          src={product?.imageUrl || "/placeholder.svg"} 
                          alt={product?.title}
                          class="max-w-full max-h-full object-contain relative z-10 transition-transform duration-500 hover:scale-105"
                       />
                       {mainDiscount > 0 && (
                           <Badge class="absolute top-4 left-4 h-8 px-3 bg-destructive text-white text-sm font-bold shadow-md">
                               -{mainDiscount}%
                           </Badge>
                       )}
                  </div>
              </div>

              {/* Center/Right Column: Info & Details */}
              <div class="lg:col-span-7 space-y-8">
                  
                  {/* Title & Meta */}
                  <div>
                       <div class="flex items-center justify-between mb-4">
                           <Badge variant="secondary" class="border-border text-xs px-2.5 py-0.5 rounded-full uppercase tracking-wide text-muted-foreground">
                              {product?.category || "Hardware"}
                           </Badge>
                           <Button variant="ghost" size="icon" class="text-muted-foreground hover:text-foreground">
                               <Share2 class="w-4 h-4" />
                           </Button>
                       </div>
                       
                      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-foreground leading-tight mb-4">
                          {product?.title}
                      </h1>
                      
                      {/* Rating/Reviews Placeholder */}
                      <div class="flex items-center gap-2 mb-6">
                          <div class="flex text-yellow-400">
                             ⭐⭐⭐⭐⭐
                          </div>
                          <span class="text-sm text-muted-foreground">(4.8 de 5)</span>
                      </div>
                  </div>

                  {/* Pricing Box (Main Offer) */}
                  <div class="bg-card border border-border rounded-xl p-6 shadow-sm relative overflow-hidden group">
                      <div class="absolute top-0 right-0 p-6 opacity-10 pointer-events-none text-9xl font-black text-muted-foreground select-none">
                          %
                      </div>

                      <div class="relative z-10">
                          <p class="text-sm text-muted-foreground mb-1">Melhor preço hoje em <span class="font-bold text-foreground">{mainOffer?.seller?.name}</span></p>
                          
                          <div class="flex items-end flex-wrap gap-3 mb-2">
                              {mainOffer?.oldPrice && mainOffer.oldPrice > mainOffer.price && (
                                  <span class="text-lg text-muted-foreground line-through mb-1">
                                      {formatPrice(mainOffer.oldPrice)}
                                  </span>
                              )}
                              <span class="text-5xl font-extrabold text-success tracking-tight glow-success">
                                  {formatPrice(product?.lowestPrice || 0)}
                              </span>
                          </div>

                          <p class="text-sm text-muted-foreground mb-6">
                              À vista no PIX com {mainDiscount > 0 ? `${mainDiscount}% de desconto` : 'desconto'}
                          </p>

                          <div class="flex flex-col sm:flex-row gap-3">
                               <Button size="lg" class="w-full sm:w-auto flex-1 font-bold text-lg h-12 shadow-lg hover:shadow-primary/25 bg-primary text-white" asChild>
                                  <a href={mainOffer?.url} target="_blank" rel="noopener noreferrer">
                                      <ExternalLink class="w-5 h-5 mr-2" />
                                      Ir para a Loja
                                  </a>
                              </Button>
                              <Button variant="outline" size="lg" class="w-full sm:w-auto h-12 font-semibold">
                                  <Bell class="w-5 h-5 mr-2" />
                                  Criar Alerta
                              </Button>
                          </div>
                      </div>
                  </div>

                  {/* Price History & Intelligence */}
                  <div class="space-y-4">
                      <h2 class="text-xl font-bold flex items-center gap-2">
                          <TrendingDown class="w-5 h-5 text-primary" />
                          Análise de Preço
                      </h2>
                      <PriceHistoryChart client:visible data={product?.priceHistory || []} />
                  </div>

                  {/* All Offers */}
                  {product?.offers && product.offers.length > 0 && (
                      <div class="space-y-4 pt-4">
                           <h2 class="text-xl font-bold">Todas as Ofertas ({product.offers.length})</h2>
                           <OfferList offers={product.offers} />
                      </div>
                  )}

                  {/* Description */}
                  {product?.description && (
                     <div class="pt-8 border-t border-border mt-12">
                         <h2 class="text-2xl font-bold mb-6">Informações do Produto</h2>
                         <div class="prose prose-zinc dark:prose-invert max-w-none text-muted-foreground leading-relaxed">
                             <div set:html={product.description} />
                         </div>
                     </div>
                  )}

              </div>
          </div>
      )}
    </div>
  </main>
</Layout>
