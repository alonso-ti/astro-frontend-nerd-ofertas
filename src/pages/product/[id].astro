---
import Layout from '../../layouts/Layout.astro';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { ExternalLink, TrendingDown, Bell, Share2, AlertTriangle } from 'lucide-react';
import type { DbServiceRpc, ProductDetails } from '@nerd-ofertas/types';
import PriceHistoryChart from '@/components/PriceHistoryChart';
import OfferList from '@/components/OfferList.astro';
import FAQSection from '@/components/FAQSection';
import ShareButton from '@/components/ShareButton';
import PriceAlertButton from '@/components/PriceAlertButton';

export const prerender = false;

const { id } = Astro.params;
let product: ProductDetails | null = null;
let error = null;

try {
  const db = Astro.locals.runtime?.env?.DB_SERVICE;
  if (db && id) {
     product = await (db as unknown as DbServiceRpc).getProductDetails(id);
  }
} catch (e) {
  console.error("Failed to fetch product:", e);
  error = "Não foi possível carregar o produto.";
}

if (!product && !error) {
    return Astro.redirect('/404');
}

const formatPrice = (price: number) => {
    return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
    }).format(price / 100);
};

// Determine Main Offer (Lowest Price)
const mainOffer = product?.offers.reduce((prev, curr) => (prev.price < curr.price ? prev : curr), product?.offers[0]);

// Calculate discount for Main Offer
const mainDiscount = mainOffer && mainOffer.oldPrice && mainOffer.price < mainOffer.oldPrice
    ? Math.round(((mainOffer.oldPrice - mainOffer.price) / mainOffer.oldPrice) * 100)
    : 0;

// "Bad Price" Intelligence Logic
// Simple logic: if current price is > 10% of 40-day average (mock logic for now as we don't have avg in generic ProductDetails yet, using average of current offers as proxy)
const averagePrice = product && product.offers.length > 0 
    ? product.offers.reduce((acc, curr) => acc + curr.price, 0) / product.offers.length 
    : 0;
const isBadPrice = product && averagePrice > 0 && product.lowestPrice > (averagePrice * 1.1);
const badPriceDiff = product ? product.lowestPrice - averagePrice : 0;

// Schema.org Structured Data (JSON-LD)
const schemaData = product ? {
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": product.title,
  "image": product.imageUrl ? [product.imageUrl] : [],
  "description": product.description ? product.description.substring(0, 160) : `Compre ${product.title} pelo menor preço.`,
  "sku": product.id,
  "offers": {
    "@type": "AggregateOffer",
    "url": Astro.url.href,
    "priceCurrency": "BRL",
    "lowPrice": (product.lowestPrice / 100).toFixed(2),
    "offerCount": product.offers.length,
    "availability": "https://schema.org/InStock"
  }
} : null;

// BreadcrumbList Schema
const breadcrumbSchema = product ? {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "name": "Home",
    "item": Astro.site ? new URL(Astro.site).href : "https://nerdofertas.com.br"
  },{
    "@type": "ListItem",
    "position": 2,
    "name": product.category || "Produto",
    "item": `${Astro.site ? new URL(Astro.site).href : "https://nerdofertas.com.br"}/search?q=${product.category}`
  },{
    "@type": "ListItem",
    "position": 3,
    "name": product.title
  }]
} : null;
---

<Layout 
    title={product?.title || "Produto"} 
    description={`Encontre o menor preço para ${product?.title}. Compare ofertas de ${product?.offers.length} lojas.`}
    image={product?.imageUrl}
    type="product"
>
    
  {/* JSON-LD Structured Data */}
  {schemaData && (
    <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  )}
  {breadcrumbSchema && (
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  )}

  {/* Preload Main Image for LCP */}
  {product?.imageUrl && (
      <link rel="preload" as="image" href={product.imageUrl} slot="head" />
  )}

  <main class="min-h-screen bg-background pb-32 lg:pb-20"> {/* Added pb-32 for mobile footer clearance */}
    
    {/* Breadcrumb / Header Area */}
    <div class="border-b border-border bg-card">
        <div class="container mx-auto px-4 py-4 flex items-center text-sm text-muted-foreground whitespace-nowrap overflow-x-auto no-scrollbar">
            <a href="/" class="hover:text-primary transition-colors">Home</a>
            <span class="mx-2">/</span>
            <a href="/search" class="hover:text-primary transition-colors">Produtos</a>
            <span class="mx-2">/</span>
            <span class="text-foreground font-medium truncate">{product?.title}</span>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
      {error ? (
          <div class="text-center py-20 bg-destructive/5 rounded-xl border border-destructive/20">
              <h1 class="text-2xl font-bold text-destructive mb-4">Erro ao carregar produto</h1>
              <p class="text-muted-foreground">{error}</p>
              <Button variant="outline" class="mt-6" asChild><a href="/">Voltar para Home</a></Button>
          </div>
      ) : (
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
              
              {/* Left Column: Image Gallery */}
              <div class="lg:col-span-5 space-y-6">
                  <div class="bg-white rounded-2xl border border-border p-8 flex items-center justify-center aspect-square relative overflow-hidden shadow-sm sticky top-24">
                       <img 
                          src={product?.imageUrl || "/placeholder.svg"} 
                          alt={product?.title}
                          class="max-w-full max-h-full object-contain relative z-10 transition-transform duration-500 hover:scale-105"
                          width="500"
                          height="500"
                          loading="eager"
                          decoding="async"
                       />
                       {mainDiscount > 0 && (
                           <Badge class="absolute top-4 left-4 h-8 px-3 bg-destructive text-white text-sm font-bold shadow-md">
                               -{mainDiscount}%
                           </Badge>
                       )}
                  </div>
              </div>

              {/* Center/Right Column: Info & Details */}
              <div class="lg:col-span-7 space-y-8">
                  
                  {/* Title & Meta */}
                  <div>
                       <div class="flex items-center justify-between mb-4">
                           <Badge variant="secondary" class="border-border text-xs px-2.5 py-0.5 rounded-full uppercase tracking-wide text-muted-foreground">
                              {product?.category || "Hardware"}
                           </Badge>
                           <ShareButton client:load title={product?.title || ""} description={`Encontre o menor preço para ${product?.title}. Compare ofertas de ${product?.offers.length} lojas.`} />
                       </div>
                       
                      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-foreground leading-snug mb-4">
                          {product?.title}
                      </h1>
                      
                      {/* Rating/Reviews Placeholder */}
                      <div class="flex items-center gap-2 mb-6">
                          <div class="flex text-yellow-400">
                             ⭐⭐⭐⭐⭐
                          </div>
                          <span class="text-sm text-muted-foreground">(4.8 de 5)</span>
                      </div>
                  </div>

                  {/* "Bad Price" Intelligence Indicator */}
                  {isBadPrice && (
                      <div class="bg-orange-50 dark:bg-orange-950/30 border border-orange-200 dark:border-orange-900/50 rounded-lg p-4 flex items-start gap-3">
                          <AlertTriangle class="w-5 h-5 text-orange-600 dark:text-orange-500 shrink-0 mt-0.5" />
                          <div>
                              <h3 class="font-bold text-orange-700 dark:text-orange-400 text-sm">Preço acima da média</h3>
                              <p class="text-xs text-orange-600/80 dark:text-orange-400/80 mt-1">
                                  Este produto está cerca de <strong>{formatPrice(badPriceDiff)}</strong> mais caro que o normal. Recomendamos criar um alerta de preço.
                              </p>
                          </div>
                      </div>
                  )}

                  {/* Pricing Box (Main Offer) - Defines Desktop View */}
                  <div class="hidden lg:block bg-card border border-border rounded-xl p-6 shadow-sm relative overflow-hidden group">
                      <div class="absolute top-0 right-0 p-6 opacity-10 pointer-events-none text-9xl font-black text-muted-foreground select-none">
                          %
                      </div>

                      <div class="relative z-10">
                          <p class="text-sm text-muted-foreground mb-1">Melhor preço hoje em <span class="font-bold text-foreground">{mainOffer?.seller?.name}</span></p>
                          
                          <div class="flex items-end flex-wrap gap-3 mb-2">
                              {mainOffer?.oldPrice && mainOffer.oldPrice > mainOffer.price && (
                                  <span class="text-lg text-muted-foreground line-through mb-1">
                                      {formatPrice(mainOffer.oldPrice)}
                                  </span>
                              )}
                              <span class="text-5xl font-extrabold text-success tracking-tight glow-success">
                                  {formatPrice(product?.lowestPrice || 0)}
                              </span>
                          </div>

                          <p class="text-sm text-muted-foreground mb-6">
                              À vista no PIX com {mainDiscount > 0 ? `${mainDiscount}% de desconto` : 'desconto'}
                          </p>

                          <div class="flex flex-col sm:flex-row gap-3">
                               <Button size="lg" class="w-full sm:w-auto flex-1 font-bold text-lg h-12 shadow-lg hover:shadow-primary/25 bg-primary text-white" asChild>
                                  <a href={mainOffer?.url} target="_blank" rel="noopener noreferrer">
                                      <ExternalLink class="w-5 h-5 mr-2" />
                                      Ir para a Loja
                                  </a>
                              </Button>
                               <PriceAlertButton 
                                 client:load 
                                 productId={product?.id || id || ""} 
                                 productTitle={product?.title || ""}
                                 currentPrice={product?.lowestPrice || 0}
                                 className="w-full sm:w-auto"
                               />
                           </div>
                      </div>
                  </div>
                  
                  {/* Mobile Pricing (Inline) */}
                  <div class="lg:hidden block">
                       <p class="text-sm text-muted-foreground mb-1">Melhor preço hoje em <span class="font-bold text-foreground">{mainOffer?.seller?.name}</span></p>
                       <div class="flex items-end gap-3 mb-2">
                            {mainDiscount > 0 && (
                                <span class="bg-destructive/10 text-destructive text-xs font-bold px-2 py-1 rounded">-{mainDiscount}%</span>
                            )}
                            <span class="text-3xl font-extrabold text-success">
                                {formatPrice(product?.lowestPrice || 0)}
                            </span>
                       </div>
                  </div>

                  {/* Price History & Intelligence */}
                  <div class="space-y-4">
                      <h2 class="text-xl font-bold flex items-center gap-2">
                          <TrendingDown class="w-5 h-5 text-primary" />
                          Análise de Preço
                      </h2>
                      <PriceHistoryChart client:visible data={product?.priceHistory || []} />
                  </div>

                  {/* All Offers */}
                  {product?.offers && product.offers.length > 0 && (
                      <div class="space-y-4 pt-4">
                           <h2 class="text-xl font-bold">Todas as Ofertas ({product.offers.length})</h2>
                           <OfferList offers={product.offers} />
                      </div>
                  )}

                  {/* Description */}
                  {product?.description && (
                     <div class="pt-8 border-t border-border mt-12">
                         <h2 class="text-2xl font-bold mb-6">Informações do Produto</h2>
                         <div class="prose prose-zinc dark:prose-invert max-w-none text-muted-foreground leading-relaxed">
                             <div set:html={product.description} />
                         </div>
                     </div>
                  )}
                  
                  {/* FAQ Section (Buscapé Style SEO) */}
                  {product && (
                    <FAQSection client:visible productTitle={product.title} category={product.category || "Hardware"} />
                  )}

              </div>
          </div>
      )}
    </div>

    {/* FIXED BOTTOM BAR (MOBILE ONLY) - Conversion Booster */}
    {product && !error && (
        <div class="fixed bottom-0 left-0 right-0 p-4 bg-background/80 backdrop-blur-md border-t border-border z-50 lg:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            <div class="flex items-center gap-3">
                <div class="flex-1">
                    <span class="text-xs text-muted-foreground block">Melhor preço</span>
                    <div class="flex items-baseline gap-2">
                         <span class="text-xl font-bold text-success">{formatPrice(product.lowestPrice)}</span>
                         {mainDiscount > 0 && <span class="text-xs text-muted-foreground line-through">{formatPrice(mainOffer?.oldPrice || 0)}</span>}
                    </div>
                </div>
                <Button size="lg" class="flex-1 font-bold shadow-lg bg-primary text-white" asChild>
                    <a href={mainOffer?.url} target="_blank" rel="noopener noreferrer">
                        Ir à Loja
                        <ExternalLink class="w-4 h-4 ml-2" />
                    </a>
                </Button>
            </div>
        </div>
    )}

  </main>
</Layout>
