---
import Layout from '../../layouts/Layout.astro';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle, CardFooter } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import { ExternalLink, ShoppingCart, Info, TrendingDown, Store } from 'lucide-react';
import type { DbServiceRpc, ProductDetails } from '@nerd-ofertas/types';
import PriceHistoryChart from '@/components/PriceHistoryChart';


export const prerender = false;

const { id } = Astro.params;
let product: ProductDetails | null = null;
let error = null;

try {
  const db = Astro.locals.runtime?.env?.DB_SERVICE;
  if (db && id) {
     product = await (db as unknown as DbServiceRpc).getProductDetails(id);
  }
} catch (e) {
  console.error("Failed to fetch product:", e);
  error = "Não foi possível carregar o produto.";
}

if (!product && !error) {
    return Astro.redirect('/404');
}

const formatPrice = (price: number) => {
    return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
    }).format(price / 100);
};

const mainOffer = product?.offers.reduce((prev, curr) => (prev.price < curr.price ? prev : curr), product?.offers[0]);
---

<Layout title={product?.title || "Produto | Nerd Ofertas"}>
  <main class="min-h-screen py-10 container mx-auto px-4">
    
    {error ? (
        <div class="text-center py-20">
            <h1 class="text-2xl font-bold text-destructive mb-4">Erro</h1>
            <p>{error}</p>
            <Button variant="outline" class="mt-4" asChild><a href="/">Voltar para Home</a></Button>
        </div>
    ) : (
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            {/* Left Column: Images */}
            <div class="lg:col-span-7 space-y-4">
                <div class="bg-card border border-border rounded-xl p-8 flex items-center justify-center aspect-square relative overflow-hidden shadow-lg group">
                    <div class="absolute inset-0 bg-gradient-to-tr from-primary/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                     <img 
                        src={product?.imageUrl || "/placeholder.svg"} 
                        alt={product?.title}
                        class="max-w-full max-h-full object-contain relative z-10 transition-transform duration-500 group-hover:scale-105"
                     />
                </div>
            </div>

            {/* Right Column: Info & Main Offer */}
            <div class="lg:col-span-5 space-y-6">
                <div>
                     <Badge variant="outline" class="mb-3 text-primary border-primary/20 bg-primary/5">
                        {product?.category || "Hardware"}
                    </Badge>
                    <h1 class="text-3xl md:text-4xl font-bold leading-tight mb-2 text-foreground">
                        {product?.title}
                    </h1>
                     {product?.isMaster && (
                        <p class="text-muted-foreground text-sm flex items-center gap-2">
                             <Info class="w-4 h-4" />
                             Agrupando {product.offers.length} ofertas
                        </p>
                    )}
                </div>

                <div class="bg-card/50 backdrop-blur-sm border border-border rounded-xl p-6 shadow-sm">
                    <div class="flex items-baseline justify-between mb-2">
                         <span class="text-sm text-muted-foreground">Melhor Preço</span>
                         {mainOffer?.oldPrice && mainOffer.oldPrice > mainOffer.price && (
                             <Badge variant="destructive" class="text-xs">
                                 -{Math.round(((mainOffer.oldPrice - mainOffer.price) / mainOffer.oldPrice) * 100)}%
                             </Badge>
                         )}
                    </div>
                    <div class="flex items-end gap-3 mb-1">
                        <span class="text-4xl lg:text-5xl font-extrabold text-primary tracking-tight">
                            {formatPrice(product?.lowestPrice || 0)}
                        </span>
                    </div>
                    <p class="text-sm text-muted-foreground mb-6">
                        à vista no PIX na loja <span class="text-foreground font-semibold">{mainOffer?.seller?.name || "Parceiro"}</span>
                    </p>

                    <div class="flex flex-col gap-3">
                         <Button size="lg" class="w-full text-lg font-bold shadow-[0_0_20px_-5px_var(--primary)] animate-pulse hover:animate-none" asChild>
                            <a href={mainOffer?.url} target="_blank" rel="noopener noreferrer">
                                <ExternalLink class="w-5 h-5 mr-2" />
                                Ir para a Loja
                            </a>
                        </Button>
                        <Button variant="outline" class="w-full" asChild>
                             <a href="/search">
                                <TrendingDown class="w-4 h-4 mr-2" />
                                Criar Alerta de Preço (Em Breve)
                             </a>
                        </Button>
                    </div>
                </div>

                {/* Price History Chart */}
                <div class="mt-6">
                    <PriceHistoryChart client:visible data={product?.priceHistory || []} />
                </div>

                
                 {/* Mini Specs or Highlights could go here */}
            </div>
        </div>
    )}

    {/* Offers List */}
    {product?.offers && product.offers.length > 0 && (
        <section class="mt-16">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <Store class="w-6 h-6 text-primary" />
                Comparar Ofertas ({product.offers.length})
            </h2>
            <div class="flex flex-col gap-3">
                {product.offers.sort((a,b) => a.price - b.price).map((offer, index) => (
                    <div class="bg-card border border-border rounded-lg p-4 flex flex-col md:flex-row items-center justify-between gap-4 hover:border-primary/50 transition-colors shadow-sm group">
                        
                        {/* Store & Info */}
                        <div class="flex items-center gap-4 w-full md:w-auto overflow-hidden">
                            <div class="flex-shrink-0 w-12 h-12 bg-white dark:bg-gray-100 rounded-full flex items-center justify-center p-1">
                                {/* Use actual logo if available, else initials */}
                                {offer.seller?.logo ? (
                                    <img src={offer.seller.logo} alt={offer.seller.name} class="max-w-full max-h-full object-contain" />
                                ) : (
                                    <span class="text-xs font-bold text-gray-800">{offer.seller?.name?.substring(0, 2).toUpperCase()}</span>
                                )}
                            </div>
                            <div class="flex flex-col overflow-hidden">
                                <span class="font-bold text-sm text-foreground truncate">{offer.seller?.name || "Loja Parceira"}</span>
                                <span class="text-xs text-muted-foreground truncate max-w-[200px] md:max-w-[300px]" title={offer.title}>{offer.title}</span>
                                {index === 0 && <Badge variant="default" class="w-fit mt-1 bg-green-600 text-[10px] px-1 py-0 h-5">Melhor Preço</Badge>}
                            </div>
                        </div>

                        {/* Price & Action */}
                        <div class="flex items-center gap-6 w-full md:w-auto justify-between md:justify-end">
                            <div class="text-right">
                                {offer.oldPrice && offer.oldPrice > offer.price && (
                                    <span class="text-xs text-muted-foreground line-through block">
                                        {formatPrice(offer.oldPrice)}
                                    </span>
                                )}
                                <span class="text-xl font-bold text-primary block">
                                    {formatPrice(offer.price)}
                                </span>
                            </div>
                            <Button size="default" class="font-bold" asChild>
                                <a href={offer.url} target="_blank" rel="noopener noreferrer">
                                    Ver Loja <ExternalLink class="w-4 h-4 ml-2" />
                                </a>
                            </Button>
                        </div>
                    </div>
                ))}
            </div>
        </section>
    )}


    {/* Description */}
     {product?.description && (
        <section class="mt-16 mb-20">
             <h2 class="text-2xl font-bold mb-6">Descrição do Produto</h2>
             <div class="prose prose-invert max-w-none bg-secondary/5 p-6 rounded-xl border border-secondary/10">
                 {/* We might need to sanitize this if it comes from raw HTML scraper, currently assume plain text or safe HTML */}
                 <div set:html={product.description} />
             </div>
        </section>
    )}

  </main>
</Layout>
