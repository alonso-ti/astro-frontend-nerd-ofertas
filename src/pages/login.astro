---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Login - Nerd Ofertas">
  <main class="min-h-screen bg-gradient-to-br from-zinc-900 via-zinc-800 to-zinc-900 flex items-center justify-center px-4">
    <div class="max-w-md w-full">
      <!-- Card -->
      <div class="bg-zinc-800/50 backdrop-blur-xl border border-zinc-700/50 rounded-2xl p-8 shadow-2xl">
        <!-- Logo/Title -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent mb-2">
            Nerd Ofertas
          </h1>
          <p class="text-zinc-400">Entre para criar alertas de preÃ§o</p>
        </div>

        <!-- Form -->
        <form id="loginForm" class="space-y-6">
          <div>
            <label for="email" class="block text-sm font-medium text-zinc-300 mb-2">
              Email
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              placeholder="seu@email.com"
              class="w-full px-4 py-3 bg-zinc-900/50 border border-zinc-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-zinc-500"
            />
          </div>

          <!-- Status Message -->
          <div id="statusMessage" class="hidden p-4 rounded-lg"></div>

          <!-- Submit Button -->
          <button
            type="submit"
            id="submitBtn"
            class="w-full py-3 px-4 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-medium rounded-lg transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Enviar Link MÃ¡gico
          </button>
        </form>

        <!-- Info -->
        <div class="mt-6 p-4 bg-zinc-900/30 border border-zinc-700/30 rounded-lg">
          <p class="text-xs text-zinc-400 text-center">
            ğŸ”’ Sem senha necessÃ¡ria. VocÃª receberÃ¡ um link de login por email que expira em 15 minutos.
          </p>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
const form = document.getElementById('loginForm') as HTMLFormElement;
const emailInput = document.getElementById('email') as HTMLInputElement;
const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
const statusMessage = document.getElementById('statusMessage') as HTMLDivElement;

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const email = emailInput.value.trim();
  
  if (!email) {
    showMessage('Por favor, digite um email vÃ¡lido', 'error');
    return;
  }

  // Disable form
  submitBtn.disabled = true;
  submitBtn.textContent = 'Enviando...';

  try {
    const response = await fetch(`${import.meta.env.PUBLIC_DB_SERVICE_URL || 'http://localhost:8787'}/auth/magic-link`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email }),
    });

    const data = await response.json();

    if (response.ok) {
      showMessage('âœ… Link enviado! Verifique seu email (pode estar no spam)', 'success');
      emailInput.value = '';
      
      // Show dev link in console if running locally
      if (import.meta.env.DEV) {
        console.log('ğŸ”— DEV MODE: Check browser console for magic link (email mock)');
      }
    } else {
      showMessage(data.error || 'Erro ao enviar link', 'error');
    }
  } catch (error) {
    console.error('Login error:', error);
    showMessage('Erro ao conectar com servidor', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Enviar Link MÃ¡gico';
  }
});

function showMessage(message: string, type: 'success' | 'error') {
  statusMessage.textContent = message;
  statusMessage.className = type === 'success'
    ? 'p-4 rounded-lg bg-green-500/10 border border-green-500/30 text-green-400'
    : 'p-4 rounded-lg bg-red-500/10 border border-red-500/30 text-red-400';
  statusMessage.classList.remove('hidden');
  
  // Auto-hide after 5 seconds
  setTimeout(() => {
    statusMessage.classList.add('hidden');
  }, 5000);
}
</script>
