---
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard';
import Hero from '../components/Hero.astro';
import { Button } from '@/components/ui/button';
import type { ScraperResult, DbServiceRpc } from '@nerd-ofertas/types';

// Force SSR to handle dynamic data
export const prerender = false;

// Mock data fallback if DB isn't ready or returns empty
const mockProducts: ScraperResult[] = [
  {
    externalId: "1",
    title: "Placa de Vídeo RTX 4060 Ti Eagle Gigabyte",
    price: 249900,
    oldPrice: 299900,
    url: "https://kabum.com.br",
    imageUrl: "https://images.kabum.com.br/produtos/fotos/461386/placa-de-video-gigabyte-nvidia-geforce-rtx-4060-ti-eagle-8g-gddr6-dlss-ray-tracing-gv-n406teagle-8gd_1685022874_g.jpg",
    availability: true,
    seller: { name: "Kabum", isOfficial: true }
  },
  {
     externalId: "2",
     title: "Processador AMD Ryzen 7 5700X3D",
     price: 139999,
     url: "https://terabyteshop.com.br",
     imageUrl: "https://img.terabyteshop.com.br/produto/g/processador-amd-ryzen-7-5700x3d-30ghz-41ghz-turbo-8-cores-16-threads-am4-100-100001503wof_187667.jpg",
     availability: true,
     seller: { name: "Terabyte" }
  },
   {
     externalId: "3",
     title: "Console PlayStation 5 Slim Edição Digital",
     price: 340000,
     oldPrice: 379900,
     url: "https://amazon.com.br",
     imageUrl: "https://m.media-amazon.com/images/I/41AG4j-iNCL._AC_SX679_.jpg",
     availability: true,
     seller: { name: "Amazon" }
  }
];

let products: ScraperResult[] = [];
let error = null;

try {
    const db = Astro.locals.runtime?.env?.DB_SERVICE;
    if (db) {
        // Try to fetch latest or "daily deals".
        const searchResults = await (db as unknown as DbServiceRpc).searchProducts("rtx");
        if (searchResults && searchResults.length > 0) {
            products = searchResults;
        } else {
             products = mockProducts; // Fallback to mock if DB empty
        }
    } else {
        console.warn("DB_SERVICE not bound in Astro locals");
        products = mockProducts;
    }
} catch (e) {
    console.error("Failed to fetch products:", e);
    error = (e as any).message;
    products = mockProducts; // Fallback on error
}
---

<Layout 
	title="Nerd Ofertas - O Comparador de Preços para Hardware e Games"
	description="Encontre o melhor preço para Placas de Vídeo, Processadores, Consoles e Jogos. Monitoramos Kabum, Amazon, Pichau, Terabyte e muito mais em tempo real."
>
	<main class="min-h-screen pb-16 bg-background">
        
        <Hero />
		
		<section class="container mx-auto px-4 py-16">
            <div class="flex items-center justify-between mb-8">
                 <div>
                    <h2 class="text-2xl font-bold tracking-tight">Ofertas em Destaque</h2>
                    <p class="text-muted-foreground">As melhores oportunidades encontradas hoje.</p>
                 </div>
                 <Button variant="outline" class="hidden sm:flex" asChild>
                    <a href="/search">Ver Todas</a>
                 </Button>
            </div>

            {error && (
                <div class="bg-destructive/10 border border-destructive/20 text-destructive p-4 rounded-lg mb-8 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                    Não foi possível carregar as ofertas em tempo real. Exibindo dados de exemplo.
                </div>
            )}

			<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {products.map((product) => (
                    <ProductCard product={product} />
                ))}
			</div>
            
            <div class="mt-8 text-center sm:hidden">
                 <Button variant="outline" size="lg" class="w-full" asChild>
                    <a href="/search">Ver Mais Ofertas</a>
                 </Button>
            </div>
		</section>

         {/* Trust Section / Footer Teaser */}
         <section class="border-t border-border/40 bg-zinc-50 dark:bg-zinc-900/50 py-16">
             <div class="container mx-auto px-4 text-center">
                 <h2 class="text-2xl font-bold mb-4">Economize com Inteligência</h2>
                 <div class="grid md:grid-cols-3 gap-8 mt-12">
                     <div class="p-6">
                         <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center mx-auto mb-4 text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M6 20V10M18 20V4"/></svg>
                         </div>
                         <h3 class="font-bold mb-2">Histórico de Preços</h3>
                         <p class="text-muted-foreground">Saiba se o preço está realmente bom ou se é "metade do dobro".</p>
                     </div>
                     <div class="p-6">
                         <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center mx-auto mb-4 text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                         </div>
                         <h3 class="font-bold mb-2">Comparação Inteligente</h3>
                         <p class="text-muted-foreground">Agrupamos ofertas de várias lojas para você comprar onde for mais barato.</p>
                     </div>
                     <div class="p-6">
                         <div class="w-12 h-12 bg-primary/10 rounded-xl flex items-center justify-center mx-auto mb-4 text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                         </div>
                         <h3 class="font-bold mb-2">Alertas (Em breve)</h3>
                         <p class="text-muted-foreground">Defina seu preço alvo e receba um aviso no Telegram quando alcançar.</p>
                     </div>
                 </div>
             </div>
         </section>
	</main>
</Layout>
