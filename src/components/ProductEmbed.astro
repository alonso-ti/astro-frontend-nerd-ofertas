---
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { ExternalLink, Star } from "lucide-react";
import type { ScraperResult } from "@nerd-ofertas/types";

interface Props {
  title: string;
  price: number;
  oldPrice?: number;
  imageUrl: string;
  storeName: string;
  marketplaceName?: string; // e.g. "Kabum" via "BringIt"
  link: string;
  rating?: number;
  ratingCount?: number;
}

const { 
  title, 
  price, 
  oldPrice, 
  imageUrl, 
  storeName, 
  marketplaceName, 
  link, 
  rating = 4.8, 
  ratingCount = 120 
} = Astro.props;

const formatPrice = (val: number) => {
  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val / 100);
};

const installmentValue = price / 10; // Simple mock 10x
---

<div class="not-prose my-8 border border-border rounded-xl bg-card overflow-hidden shadow-sm hover:shadow-md transition-shadow">
  
  {/* Header: Best Price Badge */}
  <div class="bg-muted/50 px-4 py-2 border-b border-border flex justify-between items-center">
      <div class="flex items-center gap-2">
          <Badge variant="secondary" class="font-normal text-xs uppercase tracking-wider text-muted-foreground bg-white dark:bg-zinc-800 border-border">Comparar ofertas (1)</Badge>
      </div>
      <Badge class="bg-green-600 hover:bg-green-700 text-white border-0 text-[10px] uppercase font-bold px-2 py-0.5 h-5">Melhor Preço</Badge>
  </div>

  <div class="flex flex-col md:flex-row">
      
      {/* Left: Product Image & Info */}
      <div class="md:w-5/12 p-6 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-border bg-white relative">
          <div class="relative w-full aspect-square max-w-[180px] mb-4">
              <img src={imageUrl} alt={title} class="object-contain w-full h-full" loading="lazy" />
          </div>
          
          <div class="w-full text-center space-y-1">
             <div class="flex items-center justify-center gap-1 text-yellow-500 mb-1">
                 <Star class="w-3 h-3 fill-current" />
                 <span class="text-xs font-bold text-foreground">{rating}</span>
                 <span class="text-[10px] text-muted-foreground">({ratingCount})</span>
             </div>
             <h3 class="text-sm font-medium text-zinc-700 dark:text-zinc-800 leading-tight line-clamp-2" title={title}>
                 {title}
             </h3>
          </div>
      </div>

      {/* Right: Best Offer Details */}
      <div class="md:w-7/12 p-6 flex flex-col justify-center bg-card">
           <div class="flex flex-col h-full justify-between gap-4">
               
               <div>
                   <p class="text-[10px] uppercase tracking-wide text-muted-foreground mb-1">Melhor oferta encontrada</p>
                   <div class="flex items-baseline gap-2">
                       <span class="text-3xl font-extrabold text-green-600 dark:text-green-500">
                           {formatPrice(price)}
                       </span>
                       {oldPrice && oldPrice > price && (
                           <span class="text-sm text-muted-foreground line-through decoration-red-500/50">
                               {formatPrice(oldPrice)}
                           </span>
                       )}
                   </div>
                   <p class="text-xs text-muted-foreground mt-1">
                       em até 10x de <span class="font-medium text-foreground">{formatPrice(installmentValue * 10)}</span> sem juros
                   </p>
               </div>

               <div class="space-y-3">
                   {/* Seller Info */}
                   <div class="flex items-center gap-2 p-2 rounded-lg bg-muted/40 border border-border/50">
                       <div class="w-8 h-8 rounded bg-white flex items-center justify-center border border-border shrink-0">
                           <span class="text-[10px] font-bold text-black">{storeName.substring(0, 2).toUpperCase()}</span>
                       </div>
                       <div class="flex flex-col text-xs">
                           <span class="text-muted-foreground">Vendido por:</span>
                           <span class="font-semibold text-foreground">
                               {storeName} {marketplaceName && <span class="text-muted-foreground font-normal">via {marketplaceName}</span>}
                           </span>
                       </div>
                   </div>

                   {/* CTA */}
                   <a href={link} target="_blank" rel="noopener noreferrer" class="block">
                       <Button size="lg" class="w-full font-bold bg-green-600 hover:bg-green-700 text-white shadow-sm h-12 text-base">
                           Ir à loja 
                           <ExternalLink class="w-4 h-4 ml-2" />
                       </Button>
                   </a>
               </div>

           </div>
      </div>

  </div>
  
  {/* Footer Link */}
  <div class="bg-muted/30 p-2 text-center border-t border-border">
      <a href="/deals" class="text-xs text-primary font-medium hover:underline">Ver todas as ofertas deste produto</a>
  </div>

</div>
