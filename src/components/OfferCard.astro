---
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { ExternalLink, Shield, TrendingDown, CreditCard } from 'lucide-react';
import type { ScraperResult } from '@nerd-ofertas/types';

interface Props {
  offer: ScraperResult;
  isBestOffer?: boolean;
  rank?: number;
}

const { offer, isBestOffer = false, rank } = Astro.props;

const formatPrice = (price: number) => {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  }).format(price / 100);
};

const calculateDiscount = () => {
  if (!offer.oldPrice || offer.oldPrice <= offer.price) return null;
  return Math.round(((offer.oldPrice - offer.price) / offer.oldPrice) * 100);
};

const discount = calculateDiscount();

// Calculate installments (simplified, assumes 12x max)
const maxInstallments = 12;
const installmentValue = offer.price / maxInstallments / 100;

// Store logo mapping (placeholder URLs - replace with actual assets)
const storeLogos: Record<string, string> = {
  'kabum': '/logos/kabum.svg',
  'amazon': '/logos/amazon.svg',
  'mercadolivre': '/logos/mercadolivre.svg',
  'magazineluiza': '/logos/magalu.svg',
  'default': '/logos/store-default.svg'
};

const storeLogo = storeLogos[offer.seller?.name?.toLowerCase().replace(/\s/g, '') || 'default'] || storeLogos.default;

---

<div 
  class={`
    group relative bg-card border rounded-xl overflow-hidden transition-all duration-300
    ${isBestOffer 
      ? 'border-success shadow-lg shadow-success/20 ring-2 ring-success/30' 
      : 'border-border hover:border-primary/50 hover:shadow-md'
    }
  `}
>
  {/* Best Offer Badge */}
  {isBestOffer && (
    <div class="absolute top-0 left-0 right-0 bg-gradient-to-r from-success to-green-600 text-white text-xs font-bold py-1.5 px-4 flex items-center justify-center gap-2 z-10">
      <TrendingDown class="w-4 h-4" />
      MELHOR OFERTA
    </div>
  )}

  {/* Rank Badge (if not best offer) */}
  {!isBestOffer && rank && (
    <div class="absolute top-3 left-3 bg-muted text-muted-foreground font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm z-10">
      #{rank}
    </div>
  )}

  <div class={`p-5 ${isBestOffer ? 'pt-12' : ''}`}>
    {/* Store Header */}
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="w-16 h-16 bg-white dark:bg-gray-100 rounded-lg p-2 flex items-center justify-center border border-gray-200">
          <img 
            src={storeLogo} 
            alt={offer.seller?.name || 'Loja'} 
            class="max-w-full max-h-full object-contain"
            loading="lazy"
          />
        </div>
        <div>
          <h3 class="font-bold text-foreground">{offer.seller?.name || 'Loja Parceira'}</h3>
          {offer.seller?.verified || offer.verified && (
            <div class="flex items-center gap-1 text-xs text-success mt-0.5">
              <Shield class="w-3 h-3" />
              Loja Verificada
            </div>
          )}
        </div>
      </div>
      
      {discount && (
        <Badge variant="destructive" class="font-bold text-sm px-3 py-1">
          -{discount}%
        </Badge>
      )}
    </div>

    {/* Price Section */}
    <div class="mb-4">
      {offer.oldPrice && offer.oldPrice > offer.price && (
        <p class="text-sm text-muted-foreground line-through mb-1">
          De: {formatPrice(offer.oldPrice)}
        </p>
      )}
      
      <div class="flex items-baseline gap-2 mb-2">
        <span class="text-3xl font-extrabold text-foreground">
          {formatPrice(offer.price)}
        </span>
        <span class="text-sm text-muted-foreground">à vista</span>
      </div>

      {/* Installments */}
      <div class="flex items-center gap-2 text-sm text-muted-foreground mb-3">
        <CreditCard class="w-4 h-4" />
        <span>
          ou <strong class="text-foreground">12x</strong> de{' '}
          <strong class="text-foreground">
            {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(installmentValue)}
          </strong>
        </span>
      </div>

      {/* Shipping Info (placeholder) */}
      <div class="text-xs text-success font-semibold">
        ✓ Frete Grátis para todo Brasil
      </div>
    </div>

    {/* Action Buttons */}
    <div class="flex gap-2">
      <Button 
        asChild 
        class={`
          flex-1 font-bold shadow-md transition-all duration-300
          ${isBestOffer 
            ? 'bg-success hover:bg-success/90 text-white shadow-success/30' 
            : 'bg-primary hover:bg-primary/90'
          }
        `}
      >
        <a href={offer.url} target="_blank" rel="noopener noreferrer nofollow">
          <ExternalLink class="w-4 h-4 mr-2" />
          Ir para Loja
        </a>
      </Button>
    </div>

    {/* Additional Info */}
    <div class="mt-3 pt-3 border-t border-border text-xs text-muted-foreground space-y-1">
      {offer.shipping_cost && offer.shipping_cost > 0 ? (
        <p>+ Frete: {formatPrice(offer.shipping_cost)}</p>
      ) : (
        <p class="text-success">● Frete grátis disponível</p>
      )}
      <p class="text-muted-foreground/70">
        Última atualização: {new Date(offer.lastUpdatedAt * 1000).toLocaleDateString('pt-BR')}
      </p>
    </div>
  </div>

  {/* Hover Effect Overlay */}
  <div class="absolute inset-0 bg-gradient-to-t from-primary/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
</div>
